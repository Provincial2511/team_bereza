# OncoCheck Assist 
![Image alt](https://github.com/Provincial2511/team_bereza/raw/main/website/assets/images/logo1.png)
\- это AI-помощник, в основе которого лежит локальный RAG-пайплайн для проверки соответствия лечения онкологических пациентов клиническим рекомендациям. 

- `Интерфейс`: Локальный веб-сайт, работает без внешних API.

- `Входные данные`: История болезни пациента (форматы *DOCX* и *PDF*).

- `На выходе`: Структурированный анализ выявленных несоответствий объема обследований пациента и терапии рекомендациям в двух режимах: для врача и для пациента.

---

## Функционал интерфейса

1)  **Два режима вывода результатов** 

Для врача - клинический язык,

Для пациента - доступный для пользователя язык с дополнительными расшифровками.

2)  **Поддержка PDF и DOCX форматов истории болезни**

Нативное извлечение текста или OCR для сканированных документов

3) **Процент соответствия диагностики, лечения и контроля лекарственных взаимодействий рекомендациям**

Оценка доли выявленных несоответствий, совпадений и требующих пересмотра пунктов.

4) **Ссылки на пункты рекомендаций**

В режиме "Для врача".

5) **Follow-up чат с нейросетью**

Возможность задать уточняющие вопросы в контексте уже выполненного анализа.

6) **GPU / CPU**

Переключение через переменную окружения.

---

## Архитектура

|   | Компонент | Функция | Решение |
|---|-----------| --------|---------|
| 1 | OCR / извлечение текста |Парсинг *PDF* и извлечение текста *DOCX* | PyMuPDF + EasyOCR |
| 2 | Семантический чанкер |Разбиение входных данных на части | tokenizer `all-MiniLM-L6-v2` |
| 3 | Эмбеддер /| Перевод текстовой информации в векторы | `sentence-transformers/all-MiniLM-L6-v2` |
| 4 | Векторное хранилище | Поиск в многомерных векторах | FAISS `IndexFlatL2` |
| 5 | Генератор ответа (нейросеть) | Анализ и вывод соответствий | `Qwen/Qwen2-7B-Instruct` |
| 6 | API | Веб-обёртка | FastAPI + uvicorn |

---

## Использование

### 1. Установка

```bash
pip install -r requirements.txt
```

> По умолчанию устанавливается `torch==2.5.0` (CPU). Для CUDA замените на нужную версию в `requirements.txt`.

---

### 2. Запуск

#### 2.1. Первый запуск: построение FAISS-индекса

Перед запуском веб-приложения необходимо один раз построить индекс из PDF клинических рекомендаций:

```bash
python main.py
```

Индекс сохранится в `data/faiss_index/` и при последующих запусках загружается с диска.

#### 2.2. Веб-приложение:

**CPU:**
```bash
uvicorn api.main:app --host 0.0.0.0 --port 8000
```

**GPU (CUDA):**
```bash
# Linux / Git Bash
DEVICE=cuda uvicorn api.main:app --host 0.0.0.0 --port 8000

# Windows CMD
set DEVICE=cuda && uvicorn api.main:app --host 0.0.0.0 --port 8000

# PowerShell
$env:DEVICE="cuda"; uvicorn api.main:app --host 0.0.0.0 --port 8000
```

**Открыть в браузере**: `http://localhost:8000`

*Модели и индекс загружаются один раз при старте — все последующие запросы используют уже загруженные объекты*.

#### 2.3. Пересборка индекса (после добавления нового PDF):

```bash
rm -rf data/faiss_index/
python main.py
```

---

## Конфигурация

Все параметры задаются в `src/config.py`:

```python
@dataclass
class Config:
    device: str = "cpu"          # "cpu" | "cuda"
    mode: str = "doctor"         # "doctor" | "patient"
    top_k: int = 5               # кол-во чанков для retrieval
    max_new_tokens: int = 512    # лимит генерации
    chunk_size: int = 500        # размер чанка в токенах
    overlap: int = 50            # перекрытие чанков
```

---

## Структура проекта

```
team_bereza/
├── main.py                     # CLI: построение индекса и запуск пайплайна
├── tests.ipynb                 # изолированные тесты каждого модуля
├── requirements.txt
│
├── api/
│   ├── main.py                 # FastAPI: эндпоинты + раздача website/
│   ├── state.py                # AppState: синглтон с моделью и индексом
│   └── models.py               # Pydantic-схемы запросов / ответов
│
├── src/
│   ├── config.py               # централизованная конфигурация
│   ├── ocr.py                  # извлечение текста из PDF (PyMuPDF + EasyOCR)
│   ├── parser.py               # семантический чанкер
│   ├── embeddings.py           # TextEmbedder
│   ├── faiss_store.py          # векторное хранилище
│   └── generator.py            # LocalGenerator (Qwen2-7B-Instruct)
│
├── website/
│   ├── index2.html             # выбор режима
│   ├── upload.html             # загрузка истории болезни пациента
│   ├── results.html            # результаты + чат-панель
│   └── js/app.js               # API-клиент
│
└── data/
    ├── clinical_guideline/     # PDF клинических рекомендаций
    ├── input_example/          # примеры карт (историй болезни)пациентов
    ├── faiss_index/            # кэш индекса (генерируется автоматически)
    └── generator_response/     # версионированные JSON-ответы
```

---

## API

| Метод | Путь | Описание |
|-------|------|----------|
| `POST` | `/api/analyze` | Загрузить DOCX/PDF пациента, получить анализ  |
| `POST` | `/api/chat` | Follow-up вопрос в чате с LLM в контексте сессии |

**`POST /api/analyze`**:
- `file` - карта пациента (`.docx` или `.pdf`)
- `mode` - `doctor` или `patient`

Ответ: `{ session_id, response, structured }`

**`POST /api/chat`** - JSON:
```json
{ "session_id": "...", "message": "..." }
```

---

## Тестирование

```bash
jupyter notebook tests.ipynb
```

*Ноутбук содержит изолированные тесты OCR, парсера, эмбеддера, FAISS, генератора и полный end-to-end прогон с оценкой качества ответа*.

---

## Метрики
1. Скорость генерации ответа: ~ 25 секунд
2. Точность проверки: 70%+ доля верных предсказаний к ошибочным
3. Покрытие рекомендаций: RUSSCO (100%), Минздрав (100%)

## Команда
|   | Имя | ВУЗ | Компетенции | Роль в команде |
|---|-----| ----|-------------|----------------|
| 1 | Курочкина Дарья | ГБУЗ СПб КНПЦсВМП(о) им Н.П. Напалкова, МФТИ | Онколог, аналитик данных в медицине | Осуществлении сбора данных, генерация тестовых данных, тестирование системы, презентация и постер |
| 2 | Керемет Анна | Сколтех | Магистр по направлению биоинформатика и анализ данных, аналитик данных в стартапе XELARI | Разработка фронтенда, презентация |
| 3 | Нам Евгений | ИТМО | Аспирант, инженер лаборатории Генеративного дизайна молекулярных машин | Разработка RAG-системы, презентация |
| 4 | Юрлов Максим | МФЮА | Студент 3-го курса Прикладная информатика, CV инженер в ЭРА ФПИ| Интеграция OCR-модели, интеграция RAG-пайплайна, презентация |